#!/bin/bash

# This script will create password secrets for the given Usernames.
# The password secrets will be generated by default on onetimesecrect.com, but you can change this
# to your own ots instance.
#	
#	created		- Ullrich Weichert
#	edit 		- 
#	last edit	- 24.06.2021
#	version		- 0.0
VERSION="0.0"
RELEASE="Aufmerksame Apostel analysieren afrikanische Apfelernten."
#	

#### check if the script is already running

pname="$(echo $0|sed 's@.*/@@')"
semname="${pname}.pid"
semfile="/tmp/${semname}"
if [ -f "${semfile}" ]; then
        pid="$(cat "${semfile}")"
        if [ -f "/proc/${pid}/stat" ]; then
                id="$(cat /proc/$$/stat|awk '{print $2}')"
                if [ -n "$(grep -P "\Q${id}\E" "/proc/${pid}/stat")" ]; then
                        echo "$(date): $pname is already running!"
                        exit 1
                fi
        fi
fi
echo $$ > "${semfile}"

#url=$(curl -s -d secret=${sec} -d "ttl=1209600" -u "ullrich@weichert.it:09d60525cafe97276d3a84129867dabe317a0c25" https://onetimesecret.com/api/v1/share | jq .secret_key | sed -e 's/^"//' -e 's/"$//'); echo "https://onetimesecret.com/secret/${url}"

#### Variables

OTSINSTANCE="onetimesecret.com"
APIPATH="/api/v1/"
APITOKEN=""
APIUSER=""
RECIPIENT=""
LIST=""
PWLENGTH=20
TTL=14
VERBOSE_OUT=false
BATCH_OUT=false
WUMMMMS=false

CURL=$(type -p curl)
AWK=$(type -p awk)
SED=$(type -p sed)

url="https://${OTSINSTANCE}${APIPATH}"
ttlinseconds=$(( ${TTL} * 24 * 60 * 60 ))

#### Functions

wumms ()
{
	echo -e "\n"
	echo "  WWWWWWWW                           WWWWWWWWUUUUUUUU     UUUUUUUUMMMMMMMM               MMMMMMMMMMMMMMMM               MMMMMMMM   SSSSSSSSSSSSSSS  !!!  !!!  !!! "
	echo "  W::::::W                           W::::::WU::::::U     U::::::UM:::::::M             M:::::::MM:::::::M             M:::::::M SS:::::::::::::::S!!:!!!!:!!!!:!!"
	echo "  W::::::W                           W::::::WU::::::U     U::::::UM::::::::M           M::::::::MM::::::::M           M::::::::MS:::::SSSSSS::::::S!:::!!:::!!:::!"
	echo "  W::::::W                           W::::::WUU:::::U     U:::::UUM:::::::::M         M:::::::::MM:::::::::M         M:::::::::MS:::::S     SSSSSSS!:::!!:::!!:::!"
	echo "   W:::::W           WWWWW           W:::::W  U:::::U     U:::::U M::::::::::M       M::::::::::MM::::::::::M       M::::::::::MS:::::S            !:::!!:::!!:::!"
	echo "    W:::::W         W:::::W         W:::::W   U:::::D     D:::::U M:::::::::::M     M:::::::::::MM:::::::::::M     M:::::::::::MS:::::S            !:::!!:::!!:::!"
	echo "     W:::::W       W:::::::W       W:::::W    U:::::D     D:::::U M:::::::M::::M   M::::M:::::::MM:::::::M::::M   M::::M:::::::M S::::SSSS         !:::!!:::!!:::!"
	echo "      W:::::W     W:::::::::W     W:::::W     U:::::D     D:::::U M::::::M M::::M M::::M M::::::MM::::::M M::::M M::::M M::::::M  SS::::::SSSSS    !:::!!:::!!:::!"
	echo "       W:::::W   W:::::W:::::W   W:::::W      U:::::D     D:::::U M::::::M  M::::M::::M  M::::::MM::::::M  M::::M::::M  M::::::M    SSS::::::::SS  !:::!!:::!!:::!"
	echo "        W:::::W W:::::W W:::::W W:::::W       U:::::D     D:::::U M::::::M   M:::::::M   M::::::MM::::::M   M:::::::M   M::::::M       SSSSSS::::S !:::!!:::!!:::!"
	echo "         W:::::W:::::W   W:::::W:::::W        U:::::D     D:::::U M::::::M    M:::::M    M::::::MM::::::M    M:::::M    M::::::M            S:::::S!!:!!!!:!!!!:!!"
	echo "          W:::::::::W     W:::::::::W         U::::::U   U::::::U M::::::M     MMMMM     M::::::MM::::::M     MMMMM     M::::::M            S:::::S !!!  !!!  !!! "
	echo "           W:::::::W       W:::::::W          U:::::::UUU:::::::U M::::::M               M::::::MM::::::M               M::::::MSSSSSSS     S:::::S               "
	echo "            W:::::W         W:::::W            UU:::::::::::::UU  M::::::M               M::::::MM::::::M               M::::::MS::::::SSSSSS:::::S !!!  !!!  !!! "
	echo "             W:::W           W:::W               UU:::::::::UU    M::::::M               M::::::MM::::::M               M::::::MS:::::::::::::::SS !!:!!!!:!!!!:!!"
	echo "              WWW             WWW                  UUUUUUUUU      MMMMMMMM               MMMMMMMMMMMMMMMM               MMMMMMMM SSSSSSSSSSSSSSS    !!!  !!!  !!! "
	echo ""
}

usage ()
{
	echo -e "\n\n$(basename $0)"
	echo -e "~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~"
	echo -e "This script is for generating passwords and creating onetime links for password exchange."
	echo -e "You can define a password by yourself and hand it over to this script."
	echo -e ""
	echo -e "Usage : $(basename $0) "
	echo -e ""
	echo -e "\t-W\t\tUse this script with power!"
	echo -e "\t-V\t\tMore Output as usual."
	echo -e "\t-v\t\tTell you the version"
	echo -e "\t-b\t\tFor batch processing without any output - exept returncode"
	echo -e "\t\t0\tOk!"
	echo -e "\t\t1\tnOk!"
	echo -e ""
	echo -e "\n\e[92mVersion: $VERSION"
	echo -e "Release: $RELEASE\e[0m"
	exit
}

generate_password ()
{
	openssl rand -base64 ${1}
}

generate_ots_link ()
{
	echo -e "Generating passwords links..."
	
}

#### Optionen
while getopts VbWvh opt 2>/dev/null
do
   case $opt in
	V)	VERBOSE_OUT=true;;
	b)	BATCH_OUT=true;;
	W)	WUMMMMS=true;;
	v) 	echo -e "\n$(basename $0) - Version: ${VERSION}"
		echo -e "${RELEASE}"
		exit;;
    \?) echo -e "\n($0): \033[31mERROR:\e[0m - A wild error occurs - please check the chosen options."
        exit;;
	h|*)usage
		exit;;
   esac
done


#### Check dependencies
# check for mandatory tools
if [[ -z ${SED} ]];
	then
		echo -e "\033[31mERROR:\e[0m sed wurde nicht gefunden, wird aber gebraucht. Programmabbruch!\n"
		exit
fi
if [[ -z ${CURL} ]];
	then
		echo -e "\033[31mERROR:\e[0m cURL wurde nicht gefunden, wird aber gebraucht. Programmabbruch!\n"
		exit
fi
if [[ -z ${AWK} ]];
	then
		echo -e "\033[31mERROR:\e[0m awk wurde nicht gefunden, wird aber gebraucht. Programmabbruch!\n"
		exit
fi

# check for mandatory options
#if [[ -z ${COMPARE_HASH} ]];
#	then
#		echo -e "\033[31mERROR:\e[0m Es wurde keine md5sum Ã¼bergeben. Programmabbruch!\n"
#		usage
#		exit
#fi

#### maincode

password=$(generate_password ${PWLENGTH})

echo -e "Hier kommt Ihr Passwort:\t$password"
